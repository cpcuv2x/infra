version: "3.3"
services:
  web-server:
    image: nginx:1.20.2-alpine
    ports:
      - "80:80"
    volumes:
      - ./default.conf:/etc/nginx/conf.d/default.conf

  web-service:
    build:
      context: ../../web-service
      dockerfile: Dockerfile.dev
    environment:
      APP_PORT: ${WS_APP_PORT}
      JWT_SECRET: ${WS_JWT_SECRET}
      JWT_EXPIRATION_TIME: ${WS_JWT_EXPIRATION_TIME}
      DATABASE_URL: ${WS_DATABASE_URL}
      KAFKA_ENABLED: ${WS_KAFKA_ENABLED}
      KAFKA_HOST: ${WS_KAFKA_HOST}
      KAFKA_TOPIC: ${WS_KAFKA_TOPIC}
      INFLUX_HOST: ${WS_INFLUX_HOST}
      INFLUX_TOKEN: ${WS_INFLUX_TOKEN}
      INFLUX_BUCKET: ${WS_INFLUX_BUCKET}
      INFLUX_ORG: ${WS_INFLUX_ORG}
    ports:
      - "5000:5000"
    volumes:
      - ../../web-service/src:/usr/src/app/src
      - ../../web-service/prisma:/usr/src/app/prisma
      - web-service-node-modules:/usr/src/app/node_modules
      - web-service-images:/usr/src/app/.images

  web-client:
    build:
      context: ../../web-client
      dockerfile: Dockerfile
    environment:
      VITE_GOOGLE_MAPS_API_KEY: ${WC_VITE_GOOGLE_MAPS_API_KEY}
      VITE_WEB_SERVICES_URL: ${WC_VITE_WEB_SERVICES_URL}
      VITE_WEB_SOCKET_URL: ${WC_VITE_WEB_SOCKET_URL}
    ports:
      - "3000:3000"
    volumes:
      - ../../web-client:/app
      - web-client-node-modules:/app/node_modules

  postgresdb:
    image: postgres
    restart: always
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgresdb-pgdata:/var/lib/postgresql/data

  zoo:
    image: confluentinc/cp-zookeeper:7.0.1
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_SERVER_ID: 1
      ZOOKEEPER_SERVERS: zoo:2888:3888
    volumes:
      - zoo-data:/var/lib/zookeeper/data
      - zoo-log:/var/lib/zookeeper/log

  kafka:
    image: confluentinc/cp-kafka:7.0.1
    ports:
      - "9092:9092"
      - "9999:9999"
    environment:
      KAFKA_ADVERTISED_LISTENERS: LISTENER_DOCKER_INTERNAL://kafka:19092,LISTENER_DOCKER_EXTERNAL://${DOCKER_HOST_IP:-127.0.0.1}:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: LISTENER_DOCKER_INTERNAL:PLAINTEXT,LISTENER_DOCKER_EXTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: LISTENER_DOCKER_INTERNAL
      KAFKA_ZOOKEEPER_CONNECT: "zoo:2181"
      KAFKA_BROKER_ID: 1
      KAFKA_LOG4J_LOGGERS: "kafka.controller=INFO,kafka.producer.async.DefaultEventHandler=INFO,state.change.logger=INFO"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_JMX_PORT: 9999
      KAFKA_JMX_HOSTNAME: ${DOCKER_HOST_IP:-127.0.0.1}
    volumes:
      - kafka-data:/var/lib/kafka/data
    depends_on:
      - zoo

  influxdb:
    image: influxdb:2.1
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_INIT_USERNAME}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_INIT_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_INIT_ORG}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_INIT_BUCKET}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_INIT_ADMIN_TOKEN}
    volumes:
      - influxdb-data:/var/lib/influxdb2
      - influxdb-config:/etc/influxdb2

  telegraf:
    image: telegraf:latest
    environment:
      - KAFKA_HOST=${TELEGRAF_KAFKA_HOST}
      - KAFKA_TOPIC=${TELEGRAF_KAFKA_TOPIC}
      - INFLUX_HOST=${TELEGRAF_INFLUX_HOST}
      - INFLUX_BUCKET=${TELEGRAF_INFLUX_BUCKET}
      - INFLUX_ORG=${TELEGRAF_INFLUX_ORG}
      - INFLUX_TOKEN=${TELEGRAF_INFLUX_TOKEN}
    volumes:
      - ./telegraf.conf:/etc/telegraf/telegraf.conf

  media-server:
    image: alfg/nginx-rtmp
    ports:
      - "1935:1935"
      - "8080:80"
    volumes:
      - "media-server-hls:/opt/data/hls"

volumes:
  web-service-node-modules:
  web-service-images:
  web-client-node-modules:
  postgresdb-pgdata:
  zoo-data:
  zoo-log:
  kafka-data:
  influxdb-data:
  influxdb-config:
  media-server-hls: